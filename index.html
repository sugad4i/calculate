<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>キャッキャー集計 ver0.3.0</title>
  <style>
    #header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      background-color: #f0f0f0;
      border-bottom: 1px solid #ccc;
    }
    #header h1 {
      margin: 0;
      font-size: 24px;
    }
    #header span {
      font-size: 14px;
      color: #666;
    }
    #output {
      margin-top: 30px;
      white-space: pre-line;
      font-family: monospace;
    }
    input[type="number"] {
      width: 40px;
      text-align: center;
    }
  </style>
</head>
<body>

<div id="header">
  <h1>キャッキャー集計 ver0.3.0</h1>
  <span>更新日: 2025/04/27</span>
</div>

<input type="file" id="csvFileInput" accept=".csv" />

<div id="output"></div>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
<script>
let shopData = {};
let summaryData = {};

document.getElementById('csvFileInput').addEventListener('change', function(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        const text = new TextDecoder('shift-jis').decode(e.target.result);

        Papa.parse(text, {
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
                const data = results.data;
                processData(data);
            }
        });
    };
    reader.readAsArrayBuffer(file);
});

function getYesterdayDate() {
    const today = new Date();
    today.setDate(today.getDate() - 1);
    const y = today.getFullYear();
    const m = today.getMonth() + 1;
    const d = today.getDate();
    return `${y}/${m}/${d}`;
}

function processData(data) {
    if (!data || data.length === 0) {
        document.getElementById('output').innerText = 'データが空です';
        return;
    }

    let door = 0;
    let foreignDoor = 0;
    let doorLate = 0;
    let foreignDoorLate = 0;
    let total = 0;
    let maleTotal = 0;
    let femaleTotal = 0;
    let foreignTotal = 0;
    shopData = {};

    let countColumn = null;
    for (const key of Object.keys(data[0])) {
        if (key.replace(/\s/g, '').includes('販売商品数')) {
            countColumn = key;
            break;
        }
    }
    if (!countColumn) {
        document.getElementById('output').innerText = '販売商品数の列が見つかりません';
        return;
    }

    data.forEach(row => {
        const originalItem = row['商品名']?.trim();
        if (!originalItem) return;
        const count = parseFloat(row[countColumn]) || 0;
        const itemFixed = originalItem.replace(/22~1/g, '22-1');
        const normalizedItem = itemFixed.replace(/^22-1\s*/, '');

        // 総数集計（再入場以外）
        if (!itemFixed.includes('再入場')) {
            total += count;
        }

        // 外国人数
        if (itemFixed.includes('G男性') || itemFixed.includes('G女性')) {
            foreignTotal += count;
        }

        // 性別集計
        if (itemFixed.includes('男性')) {
            maleTotal += count;
        }
        if (itemFixed.includes('女性')) {
            femaleTotal += count;
        }

        // Door集計
        if (itemFixed.includes('G男性') || itemFixed.includes('G女性')) {
            if (itemFixed.includes('22-1')) {
                foreignDoorLate += count;
            } else {
                foreignDoor += count;
            }
        } else if (itemFixed.includes('男性') || itemFixed.includes('ローカルG男性') || itemFixed.includes('女性') || itemFixed.includes('ローカルG女性')) {
            if (itemFixed.includes('22-1')) {
                doorLate += count;
            } else {
                door += count;
            }
        }

        // 店舗ごと
        const shopMatch = normalizedItem.match(/^(.+?)(ゲスト|フリー)(男性|女性)?$/);
        if (shopMatch) {
            const shopName = shopMatch[1].trim();
            const type = shopMatch[2];
            shopData[shopName] = shopData[shopName] || { guest: 0, free: 0 };
            if (type === 'ゲスト') {
                shopData[shopName].guest += count;
            }
            // フリー人数は手打ち
        }
    });

    summaryData = { total, foreignTotal, maleTotal, femaleTotal };

    generateOutput(door, foreignDoor, doorLate, foreignDoorLate);
}

function generateOutput(door, foreignDoor, doorLate, foreignDoorLate) {
    let html = '';

    html += 'キャッキャー集計\n\n';
    html += `${getYesterdayDate()}\n\n`;

    // ここで総数・外国人数・M・W出力
    html += `総数:${Math.round(summaryData.total)}(外国人${Math.round(summaryData.foreignTotal)}人)\n`;
    html += `M:${Math.round(summaryData.maleTotal)} W:${Math.round(summaryData.femaleTotal)}\n\n`;

    html += `Door : ${Math.round(door)}\n`;
    html += `外国人Door: ${Math.round(foreignDoor)}\n`;
    html += `22:00-1:00 Door: ${Math.round(doorLate)}\n`;
    html += `22:00-1:00 外国人Door: ${Math.round(foreignDoorLate)}\n`;
    html += `店ゲスト : [<input type="number" id="shopGuestInput" value="0" onchange="updateTotal()">]\n`;
    html += `店フリー: [<input type="number" id="shopFreeInput" value="0" onchange="updateTotal()">]\n\n`;

    for (const [shop, { guest }] of Object.entries(shopData)) {
        const id = shop.replace(/\s+/g, '_');
        html += `${shop}\n　<span id="total_${id}">${guest}</span>（ゲスト${Math.round(guest)} フリー[<input type="number" id="free_${id}" value="0" onchange="updateShopTotal('${id}', ${guest})">]）\n\n`;
    }

    document.getElementById('output').innerHTML = html;
}

function updateTotal() {
    const guest = parseInt(document.getElementById('shopGuestInput').value) || 0;
    const free = parseInt(document.getElementById('shopFreeInput').value) || 0;
}

function updateShopTotal(id, guest) {
    const free = parseInt(document.getElementById(`free_${id}`).value) || 0;
    const total = guest + free;
    document.getElementById(`total_${id}`).innerText = total;
}
</script>

</body>
</html>